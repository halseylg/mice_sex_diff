---
title: "Loop"
author: "Susi/Felix"
date: "31 October 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

```{r}
getwd()
```

```{r}
# library(readr)
# library(dplyr)
# library(metafor)
# library(devtools)
# library(patchwork)

# loading packages - need pacman loaded
pacman::p_load(readr, dplyr, metafor, devtools)
devtools::install_github("thomasp85/patchwork")

```

#save in a folder called "export"

```{r}
source("./R/meta_analysis.R")
source("./R/data_load_clean.R") # we need to replcae it with data_load_clean2.R
source("./R/calc_pop_stats.R")
```

# Prepare data 
```{r}
# Load raw data - save cleaned dataset as RDS for reuse
#data_raw <- load_raw("data/dr7.0_all_control_data.csv") %>%
#    clean_raw_data()
#dir.create("export", F, F)
#saveRDS(data_raw, "export/data_clean.rds")

data1 <- readRDS("export/data_clean.rds")
```


CLEAN DATA: select traits with at least 2 centers
```{r}
dat1 <-
  data1 %>%
  group_by(parameter_name) %>%
  summarize(center_per_trait = length(unique(production_center, na.rm = TRUE)))
#dat1$center_per_trait

```

```{r}
dat2 <- merge(data1, dat1) #sollte auch im grossen Datensatz so funktionieren, also ohne die uebereinstimmende Variable (trait) anzugeben
dat_moreThan1center <-
  dat2  %>%
  filter(center_per_trait >= 2)
```


```{r}
data2 <- dat_moreThan1center
min(data2$center_per_trait) #=2;ok!
```


# Define population variable

```{r}
data3 <- data2 %>%
mutate(population = sprintf("%s-%s", production_center, strain_name))
```

# Assign each unique parameter_name (=trait) a unique number ('id')

```{r}
data <- transform(data3, id = match(parameter_name, unique(parameter_name)))


```

```{r}
tail(data)

```

```{r}
n <- length(unique(data$id)) #=1:232 = 232 unique traits
```

# Create matrix to store results for all traits

```{r}
results.alltraitsx <- as.data.frame(cbind(c(1:n), matrix(rep(0, n*10), ncol = 10))) #number of individual results per trait = 10
names(results.alltraitsx) <- c("id", "lnCVR", "lnCVR_lower", "lnCVR_upper", "lnVR", "lnVR_lower", "lnVR_upper", "lnRR", "lnRR_lower", "lnRR_upper" , "sampleSize")
```

# LOOP
I am removing the variable "weight", which has some missing data, got some error message before that data were excluded below, as there are "NA"s in the rows.
```{r}
data <- data[,c(1:11,13:16)]
```



```{r}

for(i in n) {
  
  tryCatch({
    
    data_par_age <- data_subset_parameterid_individual_by_age(data, i, age_min = 0, age_center = 100)
    
    population_stats <- calculate_population_stats(data_par_age)
    
    results <- create_meta_analysis_effect_sizes(population_stats)
    
#lnCVR,  log repsonse-ratio of the coefficient of variance    
    cvr <- metafor::rma.mv(yi = effect_size_CVR, V = sample_variance_CVR, random = list(~1| strain_name, ~1|production_center, ~1|err), control=list(optimizer="optim", optmethod="Nelder-Mead"), data = results)
    results.alltraitsx[i, 2] <- cvr$b
    results.alltraitsx[i, 3] <- cvr$ci.lb
    results.alltraitsx[i, 4] <- cvr$ci.ub
    
    #lnVR, comparison of standard deviations   
    
cv <- metafor::rma.mv(yi = effect_size_VR, V = sample_variance_VR, random = list(~1| strain_name, ~1|production_center, ~1|err), control=list(optimizer="optim", optmethod="Nelder-Mead"), data = results)
    results.alltraitsx[i, 5] <- cv$b
    results.alltraitsx[i, 6] <- cv$ci.lb
    results.alltraitsx[i, 7] <- cv$ci.ub
    
    # for means, lnRR

means <- metafor::rma.mv(yi = effect_size_RR, V = sample_variance_RR, random = list(~1| strain_name, ~1|production_center, ~1|err), control=list(optimizer="optim", optmethod="Nelder-Mead"), data = results)
    results.alltraitsx[i, 8] <- means$b
    results.alltraitsx[i, 9] <- means$ci.lb
    results.alltraitsx[i, 10] <- means$ci.ub
      # for the associated sample sizes, i.e. number of centres contributing ? or combination centes/ strains (doesn't lookm like it)
        results.alltraitsx[i, 11] <- means$k
   
  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
}
 
```
 
 I still get the NA warnings / removals, but have extensively checked the data set - there are no more NAs present.
 
 I also don't understand the k<= 1, as traits that were collected by one center only had been excluded in the previous steps.
 Also, "Single-level factor(s) found in 'random' argument" is strange, as some trais that actually worked and were included have been done in one strain only. so I don't understand what's egtting thrown out here.
 
 
 
```{r}  
 results.alltraitsx$parameter_name <- data$parameter_name[match(results.alltraitsx$id, data$id)]
 results.alltraitsx$procedure <- data$procedure_name[match(results.alltraitsx $id, data$id)]
```

# Create matrix to store results for all traits
```{r}   
#write.csv(results.alltraitsx, file = "results.alltraitsTO CLEAN.csv")

```
